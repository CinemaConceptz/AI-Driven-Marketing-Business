rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== HELPER FUNCTIONS ==========
    
    function signedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function isAdmin() {
      return signedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Validate that a string field is not empty and under max length
    function isValidString(field, maxLen) {
      return field is string && field.size() > 0 && field.size() <= maxLen;
    }

    // Validate email format (basic check)
    function isValidEmail(email) {
      return email is string && email.matches('^[^@]+@[^@]+\\.[^@]+$');
    }

    // ========== USER DOCUMENTS ==========
    
    match /users/{uid} {
      // Owner can read and write their own profile
      allow read, write: if isOwner(uid);
      // Admins can read any user profile (for admin dashboard)
      allow read: if signedIn() && isAdmin();

      // User media subcollection (press images metadata)
      match /media/{mediaId} {
        allow read, write: if isOwner(uid);
      }
    }

    // ========== ADMIN ALLOWLIST ==========
    
    // Users can only check their own admin status
    // Write operations are server-only (Firebase Console or Admin SDK)
    match /admins/{uid} {
      allow read: if signedIn() && request.auth.uid == uid;
      allow write: if false;
    }

    // ========== SUBMISSIONS ==========
    
    // Artist application submissions
    // - Users can read/write their own submissions
    // - Admins can read all and update status
    match /submissions/{id} {
      allow read: if signedIn() && (isAdmin() || resource.data.uid == request.auth.uid);
      
      // Create: user can create with their own uid
      allow create: if signedIn() && request.resource.data.uid == request.auth.uid;
      
      // Update: owner can update their own, admin can update any
      allow update: if signedIn() && (isAdmin() || resource.data.uid == request.auth.uid);
      
      // Delete: server only
      allow delete: if false;
    }

    // ========== PAYMENTS ==========
    
    // Stripe payment records - created by webhook (server only)
    // - Users can read their own payment records
    // - Admins can read all payment records
    match /payments/{id} {
      allow read: if signedIn() && (isAdmin() || resource.data.uid == request.auth.uid);
      allow write: if false; // Server only via Admin SDK
    }

    // ========== EMAIL LOGS ==========
    
    // Postmark email send logs - created by API routes (server only)
    // - Only admins can read for monitoring
    match /emailLogs/{id} {
      allow read: if signedIn() && isAdmin();
      allow write: if false; // Server only via Admin SDK
    }

    // ========== AI INTAKE SYSTEM ==========
    
    // Intake chat conversations - created by API (server only)
    // - Users can read their own chat history
    // - Admins can read all for review
    match /intakeChats/{uid} {
      allow read: if isOwner(uid) || (signedIn() && isAdmin());
      allow write: if false; // Server only via Admin SDK

      match /messages/{messageId} {
        allow read: if isOwner(uid) || (signedIn() && isAdmin());
        allow write: if false; // Server only via Admin SDK
      }
    }

    // Intake profiles - structured data extracted by AI
    // - Users can read their own profile
    // - Admins can read all for review
    match /intakeProfiles/{uid} {
      allow read: if isOwner(uid) || (signedIn() && isAdmin());
      allow write: if false; // Server only via Admin SDK
    }

    // ========== CONTACT INQUIRIES ==========
    
    // Contact form submissions - created by API (server only)
    // - Admins can read all inquiries
    // - No client writes allowed
    match /contactInquiries/{id} {
      allow read: if signedIn() && isAdmin();
      allow write: if false; // Server only via Admin SDK
    }

    // ========== PDF DOWNLOADS ==========
    
    // PDF generation logs - created by API (server only)
    // - Users can read their own download history
    // - Admins can read all
    // - No client writes allowed
    match /pdfDownloads/{id} {
      allow read: if signedIn() && (isAdmin() || resource.data.uid == request.auth.uid);
      allow write: if false; // Server only via Admin SDK
    }

    // ========== FUNNEL EVENTS ==========
    
    // Conversion funnel tracking - created by client and server
    // - Users can write their own events
    // - Admins can read all for analytics
    match /funnelEvents/{id} {
      allow read: if signedIn() && isAdmin();
      allow create: if true; // Allow anonymous tracking
      allow update, delete: if false; // Server only
    }

    // ========== A/B EXPERIMENT EVENTS ==========
    
    // Experiment tracking - created by server
    // - Admins can read for analytics
    match /experimentEvents/{id} {
      allow read: if signedIn() && isAdmin();
      allow write: if false; // Server only via Admin SDK
    }

    // ========== EMAIL UNSUBSCRIBES ==========
    
    // Unsubscribe logs - created by API
    // - Admins can read for compliance
    match /emailUnsubscribes/{id} {
      allow read: if signedIn() && isAdmin();
      allow write: if false; // Server only via Admin SDK
    }

    // ========== LABELS DATABASE ==========
    
    // Label information for A&R submissions
    // - All authenticated users can read
    // - Users can add their own labels
    // - Admins can add/edit any label
    match /labels/{id} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow delete: if signedIn() && isAdmin();
    }

    // ========== SUBMISSION LOGS ==========
    
    // Track all label submissions
    // - Users can read their own submissions
    // - Admins can read all
    match /submissionLogs/{id} {
      allow read: if signedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow write: if false; // Server only via Admin SDK
    }

    // ========== SUBMISSION CAMPAIGNS ==========
    
    // Bulk submission campaigns
    // - Users can read their own campaigns
    // - Admins can read all
    match /submissionCampaigns/{id} {
      allow read: if signedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow write: if false; // Server only via Admin SDK
    }

    // ========== ARTIST PITCHES ==========
    
    // Generated pitch content
    // - Users can read their own pitch
    // - Server manages writes
    match /artistPitches/{uid} {
      allow read: if isOwner(uid) || (signedIn() && isAdmin());
      allow write: if false; // Server only via Admin SDK
    }

    // ========== CATCH-ALL DENY ==========
    
    // Deny access to any collection not explicitly defined above
    // This prevents accidental data exposure if new collections are added
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
